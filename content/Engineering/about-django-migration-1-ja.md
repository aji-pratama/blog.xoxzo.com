Title: djangoのmigrationについて
Date: 2017/04/26 14:00
Author: Akira Nonaka
Tags: django; python; migration
Slug: aboud-django-migration-1
Lang: ja

PyCon Mini in Kumamotoで発表した「django の migrationはどう動いているか？」で話した内容の一部を紹介します

djangoのmigrationはdjangoのModelの変更を データベースのスキーマに反映する仕組みです。
Modelを修正した場合以下のコマンドを実行します。

```
$ python ./manage.py makemigrations
$ python ./manage.py migrate
```

makemigrationsコマンドを実行するとmigrationフォルダ内にmigrationというPythonのソース・ファイルができあがります。
migrationファイルは、人間が読める形式になっていますので、このコマンドを実行したあとは、どのような内容になっているか
必ず目で見て確認するようにしましょう。これは公式のマニュアルでも推奨されています。

例えば、Modelを作成した後に、最初に作成されるmigrationファイルはつぎのような内容です。
```
# -*- coding: utf-8 -*-
# Generated by Django 1.10.6 on 2017-04-23 03:56
from __future__ import unicode_literals

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='SampleModel1',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200)),
                ('address', models.CharField(max_length=500, null=True)),
            ],
        ),
    ]
```
`SampleModel1`という名前のModelが作成されたということが読み取れると思います。

makemigrationsコマンドは以下のように動作します。

1. すでに出来上がっているmigrationを作成順にロードしメモリ上にモデルのグラフ構造(A)をつくる
2. 現在のModelを読み込み、モデルのグラフ構造(B)をメモリ上につるく
3. AとBを比較し、もし差分があれば、それは新たなmigrationとしてファイルに書き出す

この段階ではDBには一切変更は加えられていません。単にmigration(というPythonのソーステキスト)がmigrationフォルダに出来上がるだけです。

できあったmigrationを実際にデータベースに適用し、データベースのスキーマに反映するには migrate というコマンドを使います。これについては次回解説します。



